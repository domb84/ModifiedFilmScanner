# install driver CH341PAR.exe
# auto detect chipset using CH341A_CH347 Programmer V2.21
# select MX25L3206E 
# read rom and save it somewhere, best to capture it twice and also complete a verify
# install openjdk
# run ntktool java.exe -jar .\ntktool.jar
# load the dumped firmware
# unpack the 2 partitions
# run ntkmpe java.exe -jar .\NtkMPE.jar
# open the largest partition @000af000
# set the bitrates to one of the following 1200, 14800, 15420, 15600, 16420 
# apply the modifications
# run ntktool java.exe -jar .\ntktool.jar
 3. Compress Partition 0 using full compression (mode c)
4. Compress Partition 1 using full compression (mode c)
5. Merge the compressed partitions (in the same position as they were extracted)
# prepend the first 2296 bytes from the original firmware to the merged file

# Define paths
$prefixFile = "C:\Users\DominicBird\Mega\ch341\M127 ROM\verified_dump_2025.6.6.2.bin"
$mainFile   = "C:\Users\DominicBird\Mega\ch341\M127 ROM\verified_dump_2025.6.6.2.mod"
$outputFile = "C:\Users\DominicBird\Mega\ch341\M127 ROM\final_firmware.bin"

# Read first 2296 bytes from prefix file
$prefix = [System.IO.File]::ReadAllBytes($prefixFile)[0..2295]

# Read the full content of the main file
$main = [System.IO.File]::ReadAllBytes($mainFile)

# Combine the two
$combined = $prefix + $main

# Write to the output file
[System.IO.File]::WriteAllBytes($outputFile, $combined)

# recalulate checksum
.\ntkcalc.exe -cw $outputFile

# open CH341A_CH347 Programmer V2.21
# open final_firmware.bin
# click program to erase, write. then vrify the firmware
# auto will give errors for some reason